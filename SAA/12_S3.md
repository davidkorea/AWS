# 1. S3简介
Amazon Simple Storage Service (S3) 是互联网存储解决方案，它提供了一个简单的Web接口，让其存储的数据和文件在互联网的任何地方给任何人访问。

Amazon S3的服务给开发人员提供了高扩展性、可靠性、安全性和快速廉价的数据存储基础架构，Amazon.com网站上的内容也运行在S3上。

事实上S3是AWS最早推出的服务，可以追溯到2006年，比EC2等服务出现得还早。

## 1.1 S3基本特性
- S3是对象存储，可以在S3上存储各种类型的文件，它不是块存储（EBS是块存储）
- 文件大小可以从0 字节到5 TB
  - 使用Single Operation上传只能上传最大5 GB的文件
  - 使用分段上传（Multipart Upload）可以对文件进行分段上传，最大支持上传5 TB的文件
- S3的总存储空间是无限大的
- 文件存储在存储桶（Bucket）内，可以理解存储桶就是一个文件夹
- S3的名字是需要全球唯一的，不能与任何区域的任何人拥有的S3重名
- 存储桶创建之后会生成一个URL，命名类似于https://s3-ap-northeast-1.amazonaws.com/aws_xiaopeiqing_com
  - S3是以HTTPS的形式展现的，而非HTTP
  - ap-northeast-1表示了当前桶所在的区域
  - aws_xiaopeiqing_com表示了S3存储桶的名字，全球唯一
- S3拥有99.99%（4个9）的可用性（Availability）
  - 可用性可以理解为系统的uptime时间，即在一个自然年内（365天）有52.56分钟系统不可用
- S3拥有99.999999999%（11个9）的持久性（Durability）
  - 持久性可以认为是数据完整性/数据安全性，即在一千亿个存储在S3上的文件会有大概 1 个文件是不可读的
- S3的存储桶创建的时候可以选择所在区域（Region），但不能选择可用区（AZ），AWS会负责S3的高可用、容灾问题
  - S3创建的时候可以选择某个AWS区域，一旦选择了就不能更改
  - 如果要在其他区域使用该S3的内容，可以使用**跨区域复制**
- S3拥有不同的等级（Standard, Stantard-IA, Onezone-IA, RRS, Glacier）
- 启用了版本控制（Version Control）你可以恢复S3内的文件到之前的版本
- S3可以开启生命周期管理，对文件在不同的生命周期进行不同的操作
  - 比如，文件在创建30天后迁移到便宜的S3等级（S3-IA），再经过30天进行归档（迁移到Glacier），再过30天就进行删除
- ~~要启用生命周期管理需要先启用版本控制功能~~ 现在已经不需要了
- S3支持加密功能（后面的课程会详细讲解这一部分内容）
- 使用访问控制列表（Access Control Lists）和桶策略（Bucket Policy）可以控制S3的访问安全
- 在S3上成功上传了文件，你将会得到一个HTTP 200的状态反馈

## 1.2 数据一致性模型
- 对**新对象**的PUTs操作具有写后读一致性（Read after Write consistency）
  - 即如果向S3存储桶写入一个新的文件（PUT操作），那么S3在返回HTTP 200成功状态前会先把数据同步到AWS的多个物理位置
  - 即向S3存储桶写入一个新的数据，马上就可以读取这个新的数据
- 对**覆盖/更新**PUTs操作以及DELETES操作具有最终一致性（Eventual consistency）
  - 对于文件的更新和删除，结果不会马上显现，但最终会显现
  - 如果对一个已有的数据进行覆盖（覆盖PUTS操作）然后马上尝试读取该数据，因为数据可能还没有同步，因此有可能读取到的是旧的数据
  - 如果删除一个已有的数据（DELETES操作）然后马上尝试读取该数据，因为数据可能还没有同步，因此有可能还能读到这个数据

## 1.3 Key-Value store
S3是基于对象的，每一个对象包括了这些参数
- 键（Key）：可以认为是数据的名字
- 值（Value）：表示数据本身
- 版本号（Version ID）：对于启用了版本控制的存储桶来说很重要
- 元数据（Metadata）：关于数据的描述，比如说数据的创建时间，更改时间，文件类型，文件大小等信息
- 访问控制信息：能管理对Bucket内文件的访问权限

## 1.4 不同的S3存储类型
- Standard –  默认的存储类：如果上传对象时未注明则S3会分配这个类型的存储
- Reduced Redundancy – 低冗余存储（RRS）：可用于存储可再生的数据，因为该类型的文件持久性最低。目前大部分区域的RRS价格比Standard的价格还要高，因此绝大部分情况下都不会再使用RRS，RRS的类型也将会在不久的将来被淘汰。
- Standard – IA（Infrequently Accessed）：用于保存不经常访问的数据，但是需要访问的时候也能很快地访问到。存储的价格比标准S3便宜，但是读取的费用比标准的S3高，也因为如此才要把不经常访问的数据放到这种类型的S3上。并且数据跨了多个AWS地理位置。
- Onezone – IA：同上，但数据只保存到一个AWS可用区内
- Glacier：非常便宜，仅用于做归档。从Glacier读取数据需要花费3-5个小时。


## 1.5 S3的收费标准
- 存储费用
  - 按每GB的存储收费，存储内容越多，综合单价越便宜
- 请求
  - S3的PUT, COPY, POST或LIST等请求也需要按请求数收费
  - DELETE请求不收费
- 存储管理费用
  - 包括了S3清单，S3分析和S3对象标记功能的费用
- 数据传输费用
  - 包括S3通过互联网传入和传出的费用，在同一个区域，S3存储桶之间或从S3传输到其他AWS服务均不收费
-v传输加速费用
  - Transfer Acceleration 定价要加到数据传输定价上
  
通常，存储桶拥有者将支付与他们的存储桶相关联的所有 Amazon S3 存储和数据转移费用。但是，存储桶拥有者可以将存储桶配置为**申请方付款存储桶（requestor pay bucket）**。使用申请方付款存储桶时，申请方 (而不是存储桶拥有者) 将支付请求和从存储桶下载数据的费用。存储桶拥有者将始终支付存储数据的费用。

## 1.6 S3 传输加速（Transfer Acceleration）
Amazon S3 Transfer Acceleration 可在客户与 S3 存储桶之间实现快速、轻松、安全的远距离文件传输。Transfer Acceleration 利用 Amazon CloudFront 的全球分布式边缘站点。当数据到达某个边缘站点时，会被经过优化的网络路径路由至 Amazon S3。

可以使用[Amazon S3 Transfer Acceleration - Speed Comparison](http://s3-accelerate-speedtest.s3-accelerate.amazonaws.com/en/accelerate-speed-comparsion.html) 速度比较工具来比较不同区域内的启用传输加速与不启用传输加速的情况下的上传速度。

# 2. S3版本控制
本教程主要讲解如何使用S3的版本控制（Version Control）功能。

知识点
- 启用版本控制后S3会保存一个文件的所有版本，包括所有历史写入的版本，即使删除了的文件也会保存
- 版本控制是很好的备份工具
- 启用了版本控制功能之后，要恢复一个文件，只需要删除删除标记（Delete Marker）即可
- 版本控制默认不开启，但一旦启用，就不能关闭，只能暂停
- 版本控制一经开启，所有在这个S3桶内的对象都会受用
- 版本控制可以和生命周期规则集成使用
- 使用MFA (Multi-Factor Authentication，多重认证) Delete可以在删除文件的时候增加多一层安全保障，防止用户进行误删除操作
- 因为S3版本控制保存了一个文件对象的所有版本，每一个版本都会相应进行收费，因此费用会比不启用版本控制的S3桶要高
  - 举个例子，如果一个1 MB的文件有5个历史版本，那么你将会被收取等同于5 MB的单一文件的费用
  
# 3. S3跨区域同步

知识点
- 启用S3跨区域复制首先需要在**源S3存储桶**和**目标S3存储桶**都开启S3版本控制功能
- 源S3存储桶和目标S3存储桶**不能位于同一个区域**
- 在开启跨区域复制前的**已存在的文件不会被自动同步**
- 开启跨区域复制之后，新增加的文件会被自动同步
- 跨区域复制**不能叠加，意味着数据不可以从A同步到B，然后再同步到C？？？？？** 不能A->C？？
- 文件的删除标记（Delete markers）**不会**被同步
  - 意味着如果在A存储桶删除了一个文件，B存储桶的这个文件也**不会**被删除
- 更新：删除文件，文件的某一个版本或者删除删除标记（Delete Marker）是不会被同步的
- 同一个文件，改名后再次上传，会被当作之前文件的新版本，不会重新被上传。同时也会更新至复制S3中并生成一个新版本
- **源存储桶和目标存储桶都已经同样的文件，把源存储桶里面的文件删除，不会自动删除目标存储桶里面的文件**
  - **如果现在在源存储桶里面把删除的的文件重新upload上去，那么目标存储桶会有新的文件版本出现**
  
# 4. S3生命周期管理和Glacier
- 启用S3生命周期管理，~~必须要先启用S3版本控制功能~~，现在已经不需要先启动S3版本控制就可以直接开启生命周期管理了
- 可以对文件当前的版本和历史版本进行生命周期管理
- 生命周期管理可以做到（X，Y，Z为自定义天数）
  - （转换操作）在文件创建的X天后将文件移动到Standard – IA (Infrequently Accessed)
  - （转换操作）再过Y天将文件移动到Glacier
  - （过期操作）再过Z天将文件永久删除
- 转换到Glacier时，不需要先创建一个Glacier桶吗?
  - 实际上并没有一种叫做Glacier的桶，还是原来的桶，生命周期管理只是把整个桶或者某些文件换不同的存储类型（Standard, Standard-IA, RRS, Glacier）而已。

![](https://i.loli.net/2019/06/16/5d05ca3edd26323868.png)
![](https://i.loli.net/2019/06/16/5d05ca43cf48511218.png)
![](https://i.loli.net/2019/06/16/5d05ca4708d0577536.png)
