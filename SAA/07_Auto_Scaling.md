# 弹性伸缩（Auto Scaling）

详细设置步骤： [Amazon EC2 Auto Scaling 入门](https://docs.aws.amazon.com/zh_cn/autoscaling/ec2/userguide/GettingStartedTutorial.html#gs-create-lt)

亚马逊弹性伸缩（Auto Scaling）能自动地增加/减少EC2实例的数量，从而让你的应用程序一直能保持可用的状态。

你可以预定义Auto Scaling，使其在需求高峰期自动增加EC2实例，而在需求低谷自动减少EC2实例。这样不仅能让你的应用程序一直保持健康的状态，而且也节省了你为EC2实例所付出的费用。

Auto Scaling 适用于那些需求稳定的应用程序，同时也适用于在每小时、每天、甚至每周都有需求变化的应用程序。

- Auto Scaling能保证你一直拥有一定数量的EC2实例来分担应用程序的负载
- Auto Scaling能带来更高的容错性、更好的可用性和更高的性价比
- 你可以控制伸缩的策略来决定在什么时候终止和创建EC2实例，以处理动态变化的需求
- 默认情况下，Auto Scaling能控制每一个可用区内所运行的实例数量尽量平均
  - 为了达到这个目标，Auto Scaling在需要启动新实例的时候，会选择一个目前拥有运行实例最少的可用区
  
# 1. 启动配置（Launch Configuration）
- 启动配置是弹性伸缩组用来启动EC2实例的时候所使用的模板
- 启动配置包含了镜像文件（AMI），实例类型、密钥对、安全组和挂载的存储设备
- 一个启动配置可以关联多个Auto Scaling组
- **启动配置一经创建不能被更改，只能删除重建**
- 启动配置中可以使用CloudWatch的基础监控（Basic Monitoring）或者详细监控（Detail Monitoring）
# 2. 弹性伸缩组（Auto Scaling Group）
- 弹性伸缩组（ASG）是弹性伸缩的核心，它包含了多个拥有类似配置/类型的EC2实例，这些实例被逻辑上认为是一样的
- 弹性伸缩组需要的几个参数：
  - 启动配置（Launch Configuration）：它决定了EC2使用什么模板，模板内容包括了镜像文件（AMI），实例类型、密钥对、安全组和挂载的存储设备
  - 最小和最大的性能：决定了在弹性伸缩的情况下，EC2实例数量的浮动范围
  - 所需的性能：决定了这个弹性伸缩组要保持的运作所需要的基本的EC2实例数量；如果没有填写，则默认为其数值等同于最小的性能
  - 可用区和子网：定义EC2实例启动时候所在的可用区和子网信息
  - 参数和健康检查：参数定义了何时启动新实例，何时终止旧实例；健康检查决定了实例的健康状态。
- **如果一个EC2实例的健康状态变成“不健康”，那么ASG会终止这个EC2实例，并且自动启动一个新的EC2实例**
- 弹性伸缩组（ASG）只能在某一个AWS区域内运行，**不能跨越多个区域**
- 如果启动配置（Launch Configuration）有更新，那么之后启动的新EC2实例会使用新的启动配置，而旧的EC2实例不受影响
  - 启动配置的确是不能更改的，只能删除重建。但是弹性伸缩组可以关联新的启动配置（即更新版本的启动配置），之后启动的EC2实例就会用这个新的启动配置。
- 从AWS管理平台你可以直接删除一个弹性伸缩组（ASG）；从AWS CLI你只能先将最小的性能和需求的性能两个参数设置为0，才能删除这个弹性伸缩组。
# 3. 扩展选项
- 始终保持当前实例级别：比如始终保持一个ASG有恒定的3个健康实例
  
- 手动扩展：手动更改参数最大容量、最小容量或者所需容量来控制ASG内实例的数量

- 按计划扩展Scheduled scaling：根据定义的具体时间来弹性扩展实例的数量

- 使用**扩展策略**调整此组的容量：结合CloudWatch来基于参数进行扩展（比如说当CPU利用率持续10分钟在70%以上就自动进行向上扩展，即增加EC2实例数量；而当CPU利用率持续10分钟在30%以下就自动进行向下扩展，即减少EC2实例数量）
  - 使用**目标跟踪扩展策略**扩展 Auto Scaling 组
    ![]()
  - 使用**分步扩展策略**或**简单扩展策略**扩展 Auto Scaling 组
    - **分步扩展策略**
      ![]()
    - *简单扩展策略**
      ![]()
      
      
扩展阅读：更多关于扩展选项的内容可以查看扩展 Auto Scaling 组的大小

# 4. 默认的实例终止策略
如果你的Auto Scaling Group中包含了分布在不同可用区的实例时，当涉及到需要终止实例的情况下，Auto Scaling Group会按照以下顺序的规律终止实例。

## 4.1 选择哪一个可用区？
- 选择当前最多实例并且至少有一个实例不受**缩小保护**的可用区  
- 如果以上的可用区存在多个，则选择使用最旧的启动配置的实例所在的可用区
## 4.2 选择哪一个实例？
- 选择一个使用最旧启动配置并且不受保护的实例，如果有多个，则
- 选择一个不受保护的，最接近下一个计费小时的实例，如果还有多个，则
- 随机终止一个实例

![保护免于缩减](https://i.loli.net/2019/08/02/5d43a489cdfb083716.png)

弹性伸缩（Auto Scaling）可以和弹性负载均衡（Elastic Load Balancing）一起配合使用，这样能保证通过一个DNS地址对外提供服务，而后台能一直保证有一定数量的健康EC2实例处理相应的负载。





















