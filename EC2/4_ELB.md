-  All Load Balancers have health check capability
- Application Load Balancers for HTTP / HTTPs & Websocket
- Network Load Balancer for TCP
- **CLB and ALB** support **SSL certificates** and provide SSL termination
- **Stickiness works for CLB & ALB**



# 1. ALB

- Stickiness can be enabled at the target group level
  - Same request goes to the same instance
  - Stickiness is directly generated by the ALB (not the application)
  - The “cookie” used for stickiness has an expiration date you control
  - Use case: make sure the user doesn’t lose his session data
  - Enabling stickiness may bring imbalance to the load over the backend EC2 instances
  
![](https://i.loli.net/2019/08/20/YyhSITpow1LRCVa.png)

- ALB support HTTP/HTTPS & Websockets protocols
- The application servers don’t see the IP of the client directly
  - The true IP of the client is inserted in the header **X-Forwarded-For**
  - We can also get **Port (X-Forwarded-Port)** and **proto (X-Forwarded-Proto)**
  
![](https://i.loli.net/2019/08/20/7mPWhvyFa9Srtsb.png)

- ALB can route on based on hostname / path
- ALB is a great fit with ECS (Docker)

# 2. NLB
- NLB directly see the client IP

# 3. ELB for Solutions Architect
- Classic Load Balancers: questions on security groups, stickiness
- Application Load Balancer (Layer 7 of OSI):
  - Support **routing** based on **hostname**
    - `users.example.com `
    - `payments.example.com`
  - Support **routing** based on **path** 
    - `example.com/users `
    - `example.com/payments`
  - Support redirects (from HTTP to HTTPS for example)
  - Support dynamic host port mapping with ECS
- NLB (Layer 4 of OSI) gets a static IP per AZ:
  - Public facing: must attach Elastic IP – can help whitelist by clients
  - Private facing: will get random private IP based on free ones at time of creation
  - Has cross zone balancing
  - **Has SSL termination (Jan 2019)**
  
## 3.1 Security Groups
- Load Balancer Security Group all 80 and 443 for all
- Application Security Group: Allow traffic only from Load Balancer's SG

![](https://i.loli.net/2019/08/20/lDrYmJuT4pISALk.png)
![](https://i.loli.net/2019/08/20/SLTO1qsvBI7DFN4.png)

## 3.2 SSL Certificates

- The load balancer uses an X.509 certificate (SSL/TLS server certificate)
- You can manage certificates using ACM (AWS Certificate Manager)
- You can create upload your own certificates alternatively
- HTTPS listener:
  - You must specify a default certificate
    ![](https://i.loli.net/2019/08/20/mECSltvpfc8PFiJ.png)
  - You can add an optional list of certs to support multiple domains
  - Clients can use SNI (Server Name Indication) to specify the hostname they reach
  - Ability to specify a **security policy** to support **older versions** of SSL / TLS (**legacy clients**)
    ![](https://i.loli.net/2019/08/20/iVHgYafFIRtLCK2.png)



# 4. LB for SysOps

- Application Load Balancer:
  - Layer 7 (HTTP, HTTPS,Websocket)
  - URL based routing (hostname or path)
  - **Does not support static IP**, but has a **fixed DNS**
  - Provide SSL termination
- Network Load Balancer:
  - Layer 4 (TCP)
  - No pre-warming needed
  - **1 static IP per subnet**
  - ~~No SSL termination (SSL must be enabled by the application itself)~~
  - **Has SSL termination (Jan 2019)**
    ![](https://i.loli.net/2019/08/20/hPSgEBq3Mk8Vtu4.png)

- Exam tip: Chain an NLB and a ALB to “give” ALB a fixed IP

## 4.1 Pre-warming
- ELB scale gradually to traffic
- ELB may fail in case of sudden spike of traffic (10x traffic)
- If you expect high traffic (Christmas season), open a **support ticket** with AWS to **pre-warm** your ELB
  - Duration of traffic
  - Expected requests per second
  - Size of request (in KB)

## 4.2 SSL for Old Browsers
- Common question is: how do we **support Legacy Browsers that has an old TLS (such as TLS 1.0)** ?
- Answer: change the policy to allow for **weaker cipher (e.g. DES-CBC3-SHA for TLS 1.0)**
- Note: only a very small % of the internet uses TLS 1.0
- Elastic Load Balancing provides the following security policies for Application Load Balancers:
  - ELBSecurityPolicy-2016-08
  - ELBSecurityPolicy-FS-2018-06
  - ELBSecurityPolicy-TLS-1-2-2017-01
  - ELBSecurityPolicy-TLS-1-2-Ext-2018-06
  - ELBSecurityPolicy-TLS-1-1-2017-01
  - ELBSecurityPolicy-2015-05
  - **ELBSecurityPolicy-TLS-1-0-2015-04**  <= **allows for the weaker cipher**
- See here for more information: https://docs.aws.amazon.com/elasticloadbalancing/latest/application/create-httpslistener.html#describe-ssl-policies

## 4.3 Monitoring
All Load Balancer metrics are directly pushed to CloudWatch metrics

- BackendConnectionErrors 
- HealthyHostCount / UnHealthyHostCount
- HTTPCode_Backend_2XX: Successful request
- HTTPCode_Backend_3XX, redirected request
- Latency
- RequestCount
- **HTTPCode_ELB_4XX**: Client error codes
- **HTTPCode_ELB_5XX**: Server error codes generated by the load balancer.
- **SurgeQueueLength**: The total number of requests (HTTP listener) or connections (TCP listener) that are pending routing to a healthy instance. Help to scale out ASG. Max value is 1024
  - surge 急剧上升; 飞涨; 激增
- **SpilloverCoun**t: The total number of requests that were rejected because the surge queue is full.





























































